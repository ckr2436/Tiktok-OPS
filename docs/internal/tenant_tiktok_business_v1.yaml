openapi: 3.1.0
info:
  title: Tenant TikTok Business API
  version: 1.0.0
  description: |
    Tenant-scoped TikTok Business sync orchestration and read APIs with provider-aware
    routing that can be extended to other marketing platforms.
servers:
  - url: /api/v1
paths:
  /tenants/{workspace_id}/oauth/tiktok-business/bind:
    post:
      tags: [Tenant / TikTok Business OAuth]
      summary: Trigger a background sync after binding a TikTok Business account
      parameters:
        - $ref: '#/components/parameters/WorkspaceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BindingSyncRequest'
            examples:
              default:
                value:
                  auth_id: 123
                  scope: all
      responses:
        '202':
          description: Sync accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncResponse'
        '400': {description: Invalid scope or binding status}
        '404': {description: Binding not found}
  /tenants/{workspace_id}/providers:
    get:
      tags: [Tenant / TikTok Business]
      summary: List provider bindings within a workspace
      parameters:
        - $ref: '#/components/parameters/WorkspaceId'
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: Provider bindings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedProviderBindings'
  /tenants/{workspace_id}/providers/{provider}/accounts:
    get:
      tags: [Tenant / TikTok Business]
      summary: List accounts for a provider
      parameters:
        - $ref: '#/components/parameters/WorkspaceId'
        - $ref: '#/components/parameters/ProviderParam'
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
      responses:
        '200':
          description: Provider account list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedProviderAccounts'
  /tenants/{workspace_id}/providers/{provider}/accounts/{auth_id}/sync:
    post:
      tags: [Tenant / TikTok Business]
      summary: Dispatch a TikTok Business sync run for a specific account
      parameters:
        - $ref: '#/components/parameters/WorkspaceId'
        - $ref: '#/components/parameters/ProviderParam'
        - $ref: '#/components/parameters/AuthId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SyncRequest'
            examples:
              incremental-products:
                value:
                  scope: products
                  mode: incremental
                  product_limit: 500
                  shop_id: "12345"
                  idempotency_key: sync-123
      responses:
        '202':
          description: Sync accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncResponse'
        '400': {description: Validation error}
        '404': {description: Binding not found or provider unsupported}
  /tenants/{workspace_id}/providers/{provider}/accounts/{auth_id}/sync-runs/{run_id}:
    get:
      tags: [Tenant / TikTok Business]
      summary: Inspect a sync run for a binding
      parameters:
        - $ref: '#/components/parameters/WorkspaceId'
        - $ref: '#/components/parameters/ProviderParam'
        - $ref: '#/components/parameters/AuthId'
        - $ref: '#/components/parameters/RunId'
      responses:
        '200':
          description: Run state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncRun'
              example:
                id: 42
                schedule_id: 401
                task_name: ttb.sync.all
                status: success
                scheduled_for: '2025-01-01T00:00:00Z'
                enqueued_at: '2025-01-01T00:00:01Z'
                duration_ms: 1234
                stats:
                  requested:
                    provider: tiktok-business
                    auth_id: 1
                    scope: all
                    options:
                      mode: incremental
                    actor:
                      user_id: 7
                      workspace_id: 2
                      ip: 203.0.113.10
                    idempotency_key: demo-42
                  processed:
                    summary:
                      partial: false
                  errors: []
        '404': {description: Run not found}
  /tenants/{workspace_id}/providers/{provider}/business-centers:
    get:
      tags: [Tenant / TikTok Business]
      summary: List TikTok Business Centers
      parameters:
        - $ref: '#/components/parameters/WorkspaceId'
        - $ref: '#/components/parameters/ProviderParam'
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
        - in: query
          name: auth_id
          schema:
            type: integer
            minimum: 1
          description: Optional OAuth binding id filter
      responses:
        '200':
          description: Paged business centers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedBusinessCenters'
  /tenants/{workspace_id}/providers/{provider}/advertisers:
    get:
      tags: [Tenant / TikTok Business]
      summary: List TikTok advertisers
      parameters:
        - $ref: '#/components/parameters/WorkspaceId'
        - $ref: '#/components/parameters/ProviderParam'
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
        - in: query
          name: bc_id
          schema:
            type: string
            maxLength: 64
          description: Filter advertisers by business center id
      responses:
        '200':
          description: Paged advertisers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedAdvertisers'
  /tenants/{workspace_id}/providers/{provider}/shops:
    get:
      tags: [Tenant / TikTok Business]
      summary: List TikTok shops
      parameters:
        - $ref: '#/components/parameters/WorkspaceId'
        - $ref: '#/components/parameters/ProviderParam'
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
        - in: query
          name: advertiser_id
          schema:
            type: string
            maxLength: 64
          description: Filter shops by advertiser id
      responses:
        '200':
          description: Paged shops
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedShops'
  /tenants/{workspace_id}/providers/{provider}/products:
    get:
      tags: [Tenant / TikTok Business]
      summary: List TikTok products
      parameters:
        - $ref: '#/components/parameters/WorkspaceId'
        - $ref: '#/components/parameters/ProviderParam'
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PageSize'
        - in: query
          name: shop_id
          schema:
            type: string
            maxLength: 64
          description: Filter products by shop id
      responses:
        '200':
          description: Paged products
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PagedProducts'
components:
  parameters:
    WorkspaceId:
      in: path
      name: workspace_id
      required: true
      schema:
        type: integer
        minimum: 1
    ProviderParam:
      in: path
      name: provider
      required: true
      schema:
        type: string
        enum: [tiktok-business]
      description: Marketing provider identifier
    AuthId:
      in: path
      name: auth_id
      required: true
      schema:
        type: integer
        minimum: 1
      description: OAuth binding id
    RunId:
      in: path
      name: run_id
      required: true
      schema:
        type: integer
        minimum: 1
    Page:
      in: query
      name: page
      schema:
        type: integer
        minimum: 1
        default: 1
    PageSize:
      in: query
      name: page_size
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 50
  schemas:
    SyncRequest:
      type: object
      properties:
        scope:
          type: string
          enum: [bc, advertisers, shops, products, all]
          default: all
        mode:
          type: string
          enum: [incremental, full]
          default: incremental
        limit:
          type: integer
          minimum: 1
          maximum: 2000
        product_limit:
          type: integer
          minimum: 1
          maximum: 2000
        shop_id:
          type: string
          maxLength: 128
        since:
          type: string
          format: date-time
          description: Optional override for incremental start time
        idempotency_key:
          type: string
          maxLength: 128
          description: Reuse the same key to avoid duplicate dispatch within 24h
    ProviderBinding:
      type: object
      required: [provider, auth_id, label, status]
      properties:
        provider: {type: string, example: tiktok-business}
        auth_id: {type: integer}
        label: {type: string}
        status:
          type: string
          enum: [active, invalid]
    ProviderAccountSummary:
      type: object
      required: [auth_id, label, status]
      properties:
        auth_id: {type: integer}
        label: {type: string}
        status:
          type: string
          enum: [active, invalid]
    PagedProviderBindings:
      allOf:
        - $ref: '#/components/schemas/PagedResult'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/ProviderBinding'
    PagedProviderAccounts:
      allOf:
        - $ref: '#/components/schemas/PagedResult'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/ProviderAccountSummary'
    BindingSyncRequest:
      type: object
      required: [auth_id]
      properties:
        auth_id:
          type: integer
          minimum: 1
        scope:
          type: string
          enum: [bc, advertisers, shops, products, all]
        mode:
          type: string
          enum: [incremental, full]
        idempotency_key:
          type: string
          maxLength: 128
    SyncResponse:
      type: object
      required: [run_id, schedule_id, task_name, status]
      properties:
        run_id:
          type: integer
        schedule_id:
          type: integer
        task_name:
          type: string
          example: ttb.sync.all
        task_id:
          type: string
          nullable: true
        status:
          type: string
          example: enqueued
        idempotent:
          type: boolean
          default: false
    SyncRun:
      type: object
      required: [id, schedule_id, task_name, status, scheduled_for]
      properties:
        id: {type: integer}
        schedule_id: {type: integer}
        task_name: {type: string}
        status: {type: string}
        scheduled_for: {type: string, format: date-time}
        enqueued_at: {type: string, format: date-time, nullable: true}
        duration_ms: {type: integer, nullable: true}
        error_code: {type: string, nullable: true}
        error_message: {type: string, nullable: true}
        stats:
          type: object
          additionalProperties: true
          nullable: true
    PagedResult:
      type: object
      required: [items, page, page_size, total]
      properties:
        items:
          type: array
          items: {type: object}
        page:
          type: integer
        page_size:
          type: integer
        total:
          type: integer
    PagedBusinessCenters:
      allOf:
        - $ref: '#/components/schemas/PagedResult'
        - type: object
          properties:
            items:
              type: array
              items:
                type: object
                properties:
                  bc_id: {type: string}
                  name: {type: string}
                  status: {type: string}
                  timezone: {type: string}
                  country_code: {type: string}
                  owner_user_id: {type: string}
                  ext_created_time: {type: string, format: date-time, nullable: true}
                  ext_updated_time: {type: string, format: date-time, nullable: true}
    PagedAdvertisers:
      allOf:
        - $ref: '#/components/schemas/PagedResult'
        - type: object
          properties:
            items:
              type: array
              items:
                type: object
                properties:
                  advertiser_id: {type: string}
                  bc_id: {type: string}
                  name: {type: string}
                  display_name: {type: string}
                  status: {type: string}
                  industry: {type: string}
                  currency: {type: string}
                  timezone: {type: string}
                  country_code: {type: string}
    PagedShops:
      allOf:
        - $ref: '#/components/schemas/PagedResult'
        - type: object
          properties:
            items:
              type: array
              items:
                type: object
                properties:
                  shop_id: {type: string}
                  advertiser_id: {type: string}
                  bc_id: {type: string}
                  name: {type: string}
                  status: {type: string}
                  region_code: {type: string}
    PagedProducts:
      allOf:
        - $ref: '#/components/schemas/PagedResult'
        - type: object
          properties:
            items:
              type: array
              items:
                type: object
                properties:
                  product_id: {type: string}
                  shop_id: {type: string}
                  title: {type: string}
                  status: {type: string}
                  currency: {type: string}
                  price: {type: number, format: float}
                  stock: {type: integer, nullable: true}
